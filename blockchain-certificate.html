<link rel="import" href="/components/polymer/polymer.html">
<link rel="import" href="/components/iron-ajax/iron-ajax.html">
<link rel="import" href="common-styles.html">

<!--
`blockchain-certificate`
Displays a rendered Blockchain Certificate

@demo demo/index.html
-->

<dom-module id="blockchain-certificate">
  <template>
    <style include="common-styles"></style>

    <iron-ajax
      auto
      url=[[href]]
      handle-as="json"
      params='{"format":"json"}'
      on-response="handleResponse"
      on-error="handleError"
      debounce-duration="300">
    </iron-ajax>


    <template is="dom-if" if=[[isLoading]]>
      <h1>Loading...</h1>
    </template>
    <template is="dom-if" if=[[isErrored]]>
      <h1>[[status]]</h1>
      <a href=[[href]]>View Certificate</a>
    </template>
    <template is="dom-if" if=[[hasCertificateData]]>
      <section class="certificate-image"><img src=[[certificateImage]] /></section>
      <section class="headers">
        <h1 class="recipient">[[recipient]]</h1>
        <h2 class="title">[[title]]</h2>
        <h3 class="subtitle">[[subtitle]]</h3>
      </section>
      <section class="description">
        <p>[[description]]</p>
      </section>
      <section class="signatures">
        <img src=[[signatureImage]] />
      </section>
      <section class="seal">
        <img src=[[sealImage]] />
      </section>
    </template>
  </template>

  <script>
    Polymer({

      is: 'blockchain-certificate',

      properties: {
        href: {
          type: String,
          value: 'blockchain-certificate',
          // observer: '_hrefChanged'
        },

        /* Loading/parsing state properties */
        isLoading: {
          type: Boolean,
          value: true,
          readOnly: true
        },
        isErrored: {
          type: Boolean,
          value: false,
          readOnly: true
        },
        hasCertificateData: {
          type: Boolean,
          value: false,
          readOnly: true
        },

        /* Display properties for errored state */
        status: {
          type: String,
          readOnly: true
        },

        /* Display properties for successful "hasCertificateData" state */
        certificateImage: {
          type: String,
          readOnly: true
        },
        recipient: {
          type: String,
          readOnly: true
        },
        title: {
          type: String,
          readOnly: true
        },
        subtitle: {
          type: String,
          readOnly: true
        },
        description: {
          type: String,
          readOnly: true
        },
        signatureImage: {
          type: String,
          readOnly: true
        },
        sealImage: {
          type: String,
          readOnly: true
        }
      },
      handleResponse: function(event) {
        try {
          const response = event && event.detail && event.detail.response;
          const certificate = response.certificate || response.document.certificate
          const recipient = response.recipient || response.document.recipient
          const certificateImage = certificate.image;
          const name = `${recipient.givenName} ${recipient.familyName}`;
          const title = certificate.title || certificate.name;
          const description = certificate.description
          const signatureImage = response.document
            && response.document.assertion
            && response.document.assertion["image:signature"];
          const sealImage = certificate.issuer.image
          let subtitle = certificate.subtitle;
          if (typeof subtitle == "object") {
            subtitle = subtitle.display ? subtitle.content : ""
          }

          this._setHasCertificateData(true);
          this._setCertificateImage(certificateImage);
          this._setRecipient(name);
          this._setTitle(title);
          this._setSubtitle(subtitle);
          this._setDescription(description);
          this._setSignatureImage(signatureImage);
          this._setSealImage(sealImage);
        } catch (e) {
          this._setIsLoading(false);
          this._setHasCertificateData(false);
          this._setIsErrored(true);
          this._setStatus("Referenced certificate doesn't appear to be valid.");
        } finally {
          this._setIsLoading(false);
        }
      },
      handleError: function() {
        this._setIsLoading(false);
        this._setHasCertificateData(false);
        this._setIsErrored(true);
        this._setStatus('Failed to load certificate at URL.');
      }
    });
  </script>
</dom-module>
